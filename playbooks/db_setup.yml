# Run database setup and update application local settings.
# The application must already be deployed.
#
# Use this playbook for database migrations to do database setup
# (create new database and db user, ensure app server has access),
# and then update the local settings to reference the new database.
#
# To run with a single host or host group:
#
#    ansible-playbook playbooks/db_setup.yml --limit=cdhweb_qa
#    ansible-playbook playbooks/db_setup.yml --limit=qa
#
- hosts: geniza_qa, cdhweb_qa, prosody_qa, shxco_qa
  connection: ssh
  remote_user: pulsys
  become: true
  tasks:
    - name: Run postgresql setup tasks (ensure access, create db and user)
      ansible.builtin.include_role:
        name: postgresql
      tags: setup
    - name: Get version for currently deployed python application
      ansible.builtin.include_role:
        name: build_project_repo
        tasks_from: deploy_path_variables.yml
    - name: Update django local settings
      ansible.builtin.include_role:
        name: django
        tasks_from: install_local_settings.yml

