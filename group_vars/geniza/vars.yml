###
# Variables for Geniza that apply across all deploy groups (prod, qa, and staging)
###
---
# Paths are picky and spaces for any YAML multiline syntax causes issues
# GitHub repository
repo: "Princeton-CDH/geniza"
# name of python application
django_app: geniza
# application name
app_name: geniza
# symlink to current deploy in /var/www
symlink: "{{ app_name }}"
# wsgi file relative to apache location
wsgi_path: "{{ django_app }}/wsgi.py"
# use python 3.8
python_version: "3.8"
# nodejs version
node_version: "12"

# Override clone root to use deploy user home instead of root
clone_root: "/home/{{ deploy_user }}/repos"
# for Geniza, we don't distinguish between qa/prod paths
install_root: "/srv/www/{{ app_name }}"
# geniza local settings have a slightly different path
django_local_settings_dest: "{{ deploy }}/{{ django_app }}/settings/local_settings.py"
# configure app-specific local settings
django_local_settings_template: "geniza_settings.py"

# pul deploy user
deploy_user: "conan"

# django database backend
db_backend: "postgresql"
db_host: "{{ postgres_host }}"
# postgresql database info
application_dbuser_name: "geniza"
application_dbuser_password: "{{ vault_db_password }}"
application_db_name: "cdh_geniza"
application_db_host: "{{ postgres_host }}"

# set defaults for princeton; override for other environments
passenger_app_root: "/var/www/{{ app_name }}"
passenger_server_name: "geniza.princeton.edu"
passenger_startup_file: "{{ app_name }}/wsgi.py"
passenger_python: "{{ passenger_app_root }}/env/bin/python"

# Redirect old links from PGPv3
# specify server name to ensure https instead of http
passenger_extra_config: |
  rewrite "^/pgpsearch/\?a=object&id=(\w+).*$" "https://{{ passenger_server_name }}/documents/$1/" permanent;
  rewrite "^/pgpsearch.*$" "https://{{ passenger_server_name }}/documents/" permanent;
# Redirect to appropriate tags query after implementation
# rewrite "^/pgpsearch/\?a=tag&tag=(\w+).*$" LOCATION permanent;

# apply reasonable restrictions to licensed fonts based on referrer
font_require_referrer:
  - geniza.cdh.princeton.edu
  - test-geniza.cdh.princeton.edu
  - "*.percy.io"   # for visual testing

# override webpack build command
webpack_build_qa: 'build'
webpack_build_prod: 'build'

# solr settings
solr_collection: geniza
solr_configset: geniza

# github contexts required for deploy
deploy_contexts:
  - "Python unit tests"

# configure scripts to run as cron jobs
crontab:

  - name: "{{ app_name }} reindex"
    special_time: daily
    job: "bin/cron-wrapper {{ passenger_app_root }}/env/bin/python{{ python_version }} {{ passenger_app_root }}/manage.py index --no-progress >> {{ logging_dir }}/index.log 2>&1"
    state: present

