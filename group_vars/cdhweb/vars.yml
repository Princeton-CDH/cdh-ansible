###
# Common variables for cdhweb
###

# NOTE: Default paths are acceptable as is from all

# Github repository
repo: "Princeton-CDH/cdh-web"
# Install root (the dir where the repo will be set up on remote)
install_root: "/srv/www/cdhweb"
# Clone root (where deploy user clones repo)
clone_root: "/home/{{ deploy_user }}/repos"

# name of main django application
app_name: cdhweb
python_app: "{{ app_name }}"
django_app: "{{ app_name }}"

# python version
python_version: "3.8" # can't go past 3.8 until we get to newer ubuntu
# symlink to current deploy in /var/www
symlink: cdhweb
# use PUL deploy user of conan
deploy_user: "conan"
# wsgi path
wsgi_path: "{{ django_app }}/wsgi.py"
# nodejs version
node_version: "18"
# django database backend
db_backend: "postgresql"
db_host: "{{ postgres_host }}"

# postgresql database info
application_dbuser_name: "{{ vault_db_username }}"
application_dbuser_password: "{{ vault_db_password }}"
application_db_name: "{{ vault_db_name }}"
application_db_host: "{{ postgres_host }}"

# configure app-specific local settings
django_local_settings_template: "cdhweb_settings.py.j2"

# Database backup location â€” revert to default, with timestamp but not app version
# db_backup_path: "/home/{{ deploy_user }}/backups/pre-{{ version }}-{{ short_hash }}.sql"
# app-specific system dependencies
app_dependencies:
  - python3-opencv # for wagtail image feature detection

passenger_app_root: "/var/www/{{ app_name }}"
passenger_server_name: "cdh.princeton.edu"
passenger_startup_file: "{{ app_name }}/wsgi.py"
passenger_python: "{{ passenger_app_root }}/env/bin/python"

# for passenger config, this MUST end with a trailing slash;
# also used for replication
# media_root: /var/www/media/
# media nfs path
media_root: /mnt/nfs/cdh/cdhweb/media/

# vaulted tar file with proprietary fonts
font_archive_file: cdhweb_fonts.vault

# source host when replicating data/media (use host from inventory file)
replication_source_host: cdhweb_prod
# cdhweb prod/qa database names differ; customize db backup so the file names match
db_backup_filename: "{{ timestamp }}_{{ app_name }}.sql.bz2"
dest_backup_path: "{{ dest_backup_dir }}{{ db_backup_filename }}"

# rewrites for urls that changed in migration from 2.8 to 3.x
# specify server name to ensure https instead of http
passenger_extra_config: |
  rewrite "^/media/uploads/(.*/)?([^/]+\.(jpg|jpeg|gif|png))$" "https://{{ passenger_server_name }}/media/original_images/$2" permanent;
  rewrite "^/grants/(.*)$" "https://{{ passenger_server_name }}/engage/grants/$1" permanent;
