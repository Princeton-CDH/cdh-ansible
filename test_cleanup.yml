---
# Test script for deployment cleanup functionality
#
# HOW TO RUN:
#   ansible-playbook test_cleanup.yml                   # Basic test (keep 3)
#   ansible-playbook test_cleanup.yml --check           # Dry run (no changes made)
#   ansible-playbook test_cleanup.yml -e keep_count=5   # Test keeping 5 deployments
#

- name: Test deployment cleanup
  hosts: localhost
  connection: local
  gather_facts: true
  vars:
    test_dir: "/tmp/ansible_cleanup_test_{{ ansible_date_time.epoch }}"
    deploy_user: "{{ ansible_user_id }}"
    deploy_keep_count: "{{ keep_count | default(3) | int }}"
    
    # These are our fake deployment versions (oldest to newest)
    fake_deployments:
      - "2.1.0-old1"
      - "2.2.0-old2" 
      - "2.3.0-old3"
      - "3.0.0-keep1"
      - "3.1.0-keep2"
      - "3.2.0-keep3"
      - "4.0.0-previous"
      - "4.1.0-current"

  tasks:

    - name: "Create test directory"
      ansible.builtin.file:
        path: "{{ test_dir }}"
        state: directory

    - name: "Create fake deployments"
      ansible.builtin.file:
        path: "{{ test_dir }}/{{ item }}"
        state: directory
      loop: "{{ fake_deployments }}"

    - name: "Create current symlink"
      ansible.builtin.file:
        src: "{{ test_dir }}/{{ fake_deployments[-1] }}"
        dest: "{{ test_dir }}/current"
        state: link

    - name: "Create previous symlink"
      ansible.builtin.file:
        src: "{{ test_dir }}/{{ fake_deployments[-2] }}"
        dest: "{{ test_dir }}/previous"
        state: link

    - name: "Gather what we created"
      ansible.builtin.shell: "ls -la {{ test_dir }}/"
      register: before

    - name: "Show what we created"
      ansible.builtin.debug:
        msg: "{{ before.stdout_lines }}"

    - name: "Run the actual cleanup"
      ansible.builtin.include_tasks: roles/cleanup_deploys/tasks/main.yml
      vars:
        install_root: "{{ test_dir }}"

    - name: "Check the result: Gather what's left"
      ansible.builtin.shell: "ls -la {{ test_dir }}/"
      register: after

    - name: "Check the result: Show what's left"
      ansible.builtin.debug:
        msg: "{{ after.stdout_lines }}"

    - name: "Gather remaining deployments"
      ansible.builtin.find:
        paths: "{{ test_dir }}"
        file_type: directory
        patterns: ["[0-9]*.[0-9]*.[0-9]*-*"]
      register: remaining

    - name: "Check results - check that we kept the right number of deployments"
      ansible.builtin.assert:
        that:
          - remaining.files | length <= deploy_keep_count | int + 2
          - remaining.files | length >= deploy_keep_count | int
        success_msg: "Test passed! Kept {{ remaining.files | length }} deployments"
        fail_msg: "Test failed! Expected to keep around {{ deploy_keep_count | int + 2 }} deployments, but found {{ remaining.files | length }}"

    - name: "Verify symlinks still work"
      ansible.builtin.stat:
        path: "{{ test_dir }}/{{ item }}"
      loop: [current, previous]

    - name: "Success!"
      ansible.builtin.debug:
        msg: "âœ… All tests passed!"
          

    - name: "Clean up - Remove test directory"
      ansible.builtin.file:
        path: "{{ test_dir }}"
        state: absent
      tags: always