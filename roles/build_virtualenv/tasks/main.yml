###
# This role constructs a virtual environment and pip installs packages
# from requirements.txt.
#
##
- name: Create and build python virtual environment
  become: true
  become_user: "{{ deploy_user }}"

  block:
    # NOTE: only explicitly create virtualenv on Springdale/SELinux
    - name: Create venv with project-name-short-hash-version
      command: "virtualenv --system-site-packages {{ virtualenv_path }} --prompt '({{ repo | project_name }}-{{ short_hash }}-{{ version }}) '"
      when:  ansible_distribution == 'Springdale'

    - name: Set perms
      file:
          path: "{{ virtualenv_path }}"
          state: directory
          mode: "u+rwx,g+rwx,o-rw"
      when:  ansible_distribution == 'Springdale'

    - name: Upgrade pip in virtual environment
      pip:
        name: pip
        state: latest
        virtualenv: "{{ virtualenv_path }}"
        virtualenv_python: "{{ python_version }}"

    - name: Install app requirements via pip
      pip:
        virtualenv: "{{ virtualenv_path }}"
        requirements: "{{ deploy }}/requirements.{{ requirements_type }}"
        virtualenv_site_packages: "{{ virtualenv_site_packages }}"
        virtualenv_python: "{{ python_version }}"

  rescue:
    - include_tasks: roles/create_deployment/tasks/fail.yml
