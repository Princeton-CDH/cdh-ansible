{# This is the passenger/nginx configuration for PROXYING python wayback. #}
{# There is a separate passenger config for running python wayback on port 8080. #}
{% extends 'passenger.conf.j2' %}
{% block root %}
location / {
     proxy_pass http://localhost:8080/derrida/bn_/https://derridas-margins.princeton.edu/;
     proxy_set_header Host $host;
     proxy_set_header X-Forwarded-Proto $scheme;
     # allow intercepting errors so we can customize error page
     proxy_intercept_errors on;
  }
{% endblock %}

{% block static %}
  # look for local static files first, then pywb static files
  location ~ ^/pywb_static/(.*)$ {
      expires 10d;
      root /;
      try_files {{ passenger_static_path }}/$1 {{ passenger_app_root }}/env/lib/python{{ python_version }}/site-packages/pywb/static/$1 =404;
    }

  # serve project static files at /static/
  location /static/ {
    expires 10d;
    alias {{ passenger_static_path }};
  }

  # serve favicon.ico from /static/
  location = /favicon.ico {
      expires 10d;
      alias {{ passenger_static_path }}/favicon.ico;
  }
{% endblock %}

{# no media or fonts for this application #}
{% block media %}{% endblock %}
{% block fonts %}{% endblock %}

{% block extra_config %}
  # map sitemap urls to static copies managed with the app
  location ~ ^/sitemap(.*)$ {
      expires 10d;
      root /;
      try_files {{ passenger_app_root }}/static/sitemap$1 =404;
   }

  # configure 404 and 500 to return custom error pages included in the web archive
  # map 404/500 locations with intercept errors disabled
  location /404/ {
     proxy_pass http://localhost:8080/derrida/bn_/https://derridas-margins.princeton.edu/404/;
     proxy_set_header Host $host;
     proxy_set_header X-Forwarded-Proto $scheme;
     proxy_intercept_errors off;
   }
  location /_500/ {
     proxy_pass http://localhost:8080/derrida/bn_/https://derridas-margins.princeton.edu/_500/;
     proxy_set_header Host $host;
     proxy_set_header X-Forwarded-Proto $scheme;
     proxy_intercept_errors off;
   }
  error_page 404 /404/;
  error_page 500 /_500/;

{% endblock %}
