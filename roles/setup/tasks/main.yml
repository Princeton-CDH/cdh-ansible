---
# tasks file for setup

# Conditionally load vaulted setup variables.
# Skip based on setup tag is insufficient, ansible complains if
# the vault key is not available.

- name: Load vaulted setup variables if appropriate
  tags:
    - setup
    - never
  ansible.builtin.include_vars:
    file: vars/vault.yml
  when: geniza_deploy_only is not defined or geniza_deploy_only == ""

- name: nfsserver | add fqdn for idmapping
  ansible.builtin.lineinfile:
    path: /etc/idmapd.conf
    insertbefore: '# Domain = localdomain'
    line: "Domain = {{ nfs_host_server }}"
    state: present  
- name: nfsserver | enable id_mapping
  ansible.builtin.lineinfile:
    path: /etc/default/nfs-common
    regexp: '^NEED_IDMAPD='
    line: NEED_IDMAPD=yes
  notify: restart idmapd

- name: nfsserver | add fqdn for idmapping
  ansible.builtin.lineinfile:
    path: /etc/idmapd.conf
    insertbefore: '# Domain = localdomain'
    line: "Domain = {{ nfs_host_server }}"
    state: present  

- name: Ensure the presence of cdh nfs mount
  tags:
    - setup
    - nfs
    - never
  ansible.posix.mount:
    src: "{{ nfs_server }}:/var/nfs/cdh"
    path: "/mnt/nfs/cdh"
    state: mounted
    fstype: nfs
    opts: rw,sync,hard
  become: true
