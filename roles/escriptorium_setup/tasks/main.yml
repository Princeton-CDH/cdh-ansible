---
# custom setup tasks file for escriptorium deploy
- name: Customize eScriptorium
  become: true
  tags:
    - setup
    - never
    - escriptorium
  block:
    - name: Install private htr2hpc ssh key
      ansible.builtin.copy:
        src: files/htr2hpc_id_ed25519
        dest: "/home/{{ deploy_user }}/.ssh/htr2hpc_id_ed25519"
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        mode: 0600
    - name: Make sure ssh config file exists
      ansible.builtin.file:
        path: "/home/{{ deploy_user }}/.ssh/config"
        mode: 0600
        owner: "{{ deploy_user }}"
        group: "{{ deploy_user }}"
        state: touch
    - name: Configure ssh key for HPC access in ~/.ssh/config
      become: true
      become_user: "{{ deploy_user }}"
      ansible.builtin.blockinfile:
        path: "/home/{{ deploy_user }}/.ssh/config"
        block: |
          Host della
           HostName della.princeton.edu
           IdentityFile ~/.ssh/htr2hpc_id_ed25519

    - name: Rename default segtrain task
      ansible.builtin.replace:
        path: "{{ install_root }}/app/apps/core/tasks.py"
        regexp: '^def (segtrain\(model.*)$'
        replace: 'def es_\1'

    - name: Rename default train task
      ansible.builtin.replace:
        path: "{{ install_root }}/app/apps/core/tasks.py"
        regexp: '^def (train\(.*)$'
        replace: 'def es_\1'

    - name: Import htr2hpc segtrain and train tasks to override defaults
      ansible.builtin.blockinfile:
        path: "{{ install_root }}/app/apps/core/tasks.py"
        block: |
          # import htr2hpc replacement training tasks
          from htr2hpc.tasks import segtrain, train

        insertbefore: '(?m)\n@shared_task.*\ndef es_segtrain\(model_pk=None'
        marker: "# {mark} ANSIBLE MANAGED BLOCK"

