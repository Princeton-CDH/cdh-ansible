###
# Run django-compressor compress.
#
# This role must come after npm and virtualenv creation, as it depends on both.
# It also create a CACHE dir with the appropriate user and group permissions
# so that Apache can use the result.
###
# Ownership needs to deploy/apache for production
- name: Configure CACHE for django-compressor
  file:
    path: '{{ deploy }}/static/CACHE'
    state: directory
    owner: deploy
    group: apache
    mode: 0770
# On QA server the actual owner for purposes of CACHE needs to be the
# user associated with the WSGI Daemon, in this case a manual call to sudo
- name: chgrp the CACHE folder to project user
  shell: "sudo chgrp -R {{ project_user }} {{ deploy }}/static/CACHE"
  when: group_name | regex_search('_qa$')
  args:
    warn: False
    executable: /bin/bash
- name: run ./manage.py compress to build CSS
  django_manage:
    command: compress
    app_path: "{{ deploy }}"
    virtualenv: "{{ deploy }}/env"
