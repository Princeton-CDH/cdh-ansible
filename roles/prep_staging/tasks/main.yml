###
# Prepare vhost and wsgi configurations for staging VM.  This inserts a
# correctly templated configuration for the Virtualhost and wsgi.
###
---
- name: Prepare staging VM for a run
  block:
    - name: Install a global postcss for projects that need it
      npm:
        name: '{{ item }}'
        global: yes
      with_items:
          - postcss-cli
          - autoprefixer
      # we ignore the error if it doesn't work in case we're working with a play
      # that doesn't have node installed and on path
      ignore_errors: yes
    - name: Create vhost configuration
      template:
        src: '{{ templates_dir }}/staging_vagrant/apache_vhost.conf'
        dest: /etc/httpd/conf.d/apache_vhost.conf
    - name: Create directory for wsgi settings
      file:
        state: directory
        dest: /etc/httpd/conf.d/staging
        owner: root
        group: root
    - name: Create wsgi configuration
      template:
        src: '{{ templates_dir }}/staging_vagrant/apache_wsgi.conf'
        dest: /etc/httpd/conf.d/staging/wsgi.conf
    - name: Clear /var/www/ and /srv/www
      shell: 'rm -rf /var/www/* && rm -rf /srv/www/*'
      args:
        executable: /bin/bash
        warn: false
      when: clear_staging
    - name: Remove staging db if exists
      mysql_db:
        name: staging
        state: absent
      when: clear_staging
    - name: Create staging db
      mysql_db:
        name: staging
        state: present
        encoding: utf8
  rescue:
    - include_tasks: roles/create_deployment/tasks/fail.yml
