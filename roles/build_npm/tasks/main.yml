###
# Build node_modules folder and install npm dependencies.
#
# This role installs npm packages and depends on there being a package.json
# present in the project root directory (deploy). It installs both
# devDependencies and dependencies because both are used in producing
#
# The webpack_build variable determines if true and set, whether or not a
# a webpack build step of the form `npm run build:<qa|prod>` is run.
###
---
- name: npm configuration tasks
  block:
    - name: Do npm install for dependencies
      npm:
        path: '{{ deploy }}'
    - name: Do a QA build if the role variable is set and in QA
      shell: 'npm run build:qa'
      args:
        chdir: '{{ deploy }}'
        executable: /bin/bash
      when:
        - qa is defined
        - webpack_build is defined
        - webpack_build
    - name: Do a QA build if the role variable is set and in QA
      shell: 'npm run build:prod'
      args:
        chdir: '{{ deploy }}'
        executable: /bin/bash
      when:
        - prod is defined
        - webpack_build is defined
        - webpack_build
  rescue:
    - include_tasks: roles/create_deployment/tasks/fail.yml
