---
# Opinionated Node install: prebuilt tarball from pulmirror by default.
# No "unsupported" branch; anything non-x86_64 is treated as arm64.

- name: Build_npm | Normalize version and select arch
  ansible.builtin.set_fact:
    desired_nodejs_version_v: >-
      {{ (desired_nodejs_version is match('^v')) | ternary(desired_nodejs_version, 'v' ~ desired_nodejs_version) }}
    nodejs_arch: >-
      {{ (ansible_architecture in ['x86_64', 'amd64']) | ternary('x64', 'arm64') }}
    nodejs_dir: "{{ nodejs_prefix_root | default('/usr/local') }}/node-{{ (desired_nodejs_version is match('^v')) | ternary(desired_nodejs_version, 'v' ~ desired_nodejs_version) }}-linux-{{ (ansible_architecture in ['x86_64','amd64']) | ternary('x64','arm64') }}"
    nodejs_tarball: "/usr/local/src/node-{{ (desired_nodejs_version is match('^v')) | ternary(desired_nodejs_version, 'v' ~ desired_nodejs_version) }}-linux-{{ (ansible_architecture in ['x86_64','amd64']) | ternary('x64','arm64') }}.tar.xz"

- name: Build_npm | Check current node (if any)
  ansible.builtin.command: "/usr/local/bin/node --version"
  register: node_current
  changed_when: false
  failed_when: false

- name: Build_npm | Determine whether Node install/update is needed
  ansible.builtin.set_fact:
    nodejs_needs_install: >-
      {{ (node_current.rc != 0) or ((node_current.stdout | trim) != desired_nodejs_version_v) }}

- name: Build_npm | Install Node (prebuilt)
  when: nodejs_needs_install and (nodejs_install_method | default('prebuilt')) == 'prebuilt'
  block:
    - name: Build_npm | Download prebuilt tarball (resilient)
      become: true
      ansible.builtin.get_url:
        url: "{{ nodejs_release_base_url | default('https://pulmirror.princeton.edu/mirror/node/dist') }}/{{ desired_nodejs_version_v }}/node-{{ desired_nodejs_version_v }}-linux-{{ nodejs_arch }}.tar.xz"
        dest: "{{ nodejs_tarball }}"
        mode: "0644"
        tmp_dest: "/tmp"
        timeout: "{{ nodejs_download_timeout | default(600) }}"
      register: node_prebuilt_dl
      retries: "{{ nodejs_download_retries | default(6) }}"
      delay: "{{ nodejs_download_delay | default(10) }}"
      until: node_prebuilt_dl is succeeded

    - name: Build_npm | Unpack prebuilt Node
      become: true
      ansible.builtin.unarchive:
        src: "{{ nodejs_tarball }}"
        dest: "{{ nodejs_prefix_root | default('/usr/local') }}"
        remote_src: true
        creates: "{{ nodejs_dir }}"

    - name: Build_npm | Link node/npm/npx
      become: true
      ansible.builtin.file:
        src: "{{ nodejs_dir }}/bin/{{ item }}"
        dest: "/usr/local/bin/{{ item }}"
        state: link
        force: true
      loop: [node, npm, npx]

    - name: Build_npm | Verify node version
      ansible.builtin.command: "/usr/local/bin/node --version"
      register: node_version_check
      changed_when: false
      failed_when: node_version_check.stdout | trim != desired_nodejs_version_v
