---
# Cleanup old deployment directories
# This task file can be included by other roles or used independently

- name: Find all deployment directories
  ansible.builtin.find:
    paths: "{{ install_root }}"              # e.g., /srv/www/geniza
    file_type: directory
    patterns: ["[0-9]*.[0-9]*.[0-9]*-*"]    # Matches: 4.24.0-dev-33e737, 3.15.0-63bcea
  register: all_deploy_dirs


- name: Resolve current/previous symlinks to absolute paths
  ansible.builtin.shell: readlink -f "{{ install_root }}/{{ item }}" 2>/dev/null || echo ""
  loop: [current, previous]
  register: rp_syms
  changed_when: false
  failed_when: false

- name: Build protected_dirs (absolute)
  ansible.builtin.set_fact:
    protected_dirs: >-
      {{ rp_syms.results | map(attribute='stdout') | select('string') | select() | list }}

- name: DEBUG protected + all dirs (absolute)
  ansible.builtin.debug:
    msg: |
      Protected: {{ protected_dirs }}
      All: {{ all_deploy_dirs.files | map(attribute='path') | list }}

- name: Sort & choose old unprotected (by mtime desc)
  ansible.builtin.set_fact:
    sorted_unprotected: >-
      {{ all_deploy_dirs.files
         | rejectattr('path', 'in', protected_dirs)
         | sort(attribute='mtime', reverse=true) }}

- name: Keep recent N, mark old ones to remove
  ansible.builtin.set_fact:
    dirs_to_remove: "{{ sorted_unprotected[deploy_keep_count|default(3)|int:] | map(attribute='path') | list }}"

- name: Preflight FS info
  become: true
  ansible.builtin.shell: |
    set -euxo pipefail
    echo "== mount =="
    mount | grep " {{ install_root }} " || echo "No specific mount for {{ install_root }}"
    echo "== fs type =="
    stat -f -c "%T" "{{ install_root }}"
    echo "== sample attrs (i flag)? =="
    lsattr -d "{{ install_root }}" 2>/dev/null || echo "lsattr not supported"
  register: fsinfo
  changed_when: false
  failed_when: false

- name: Show preflight
  ansible.builtin.debug:
    var: fsinfo.stdout_lines

- name: Remove old deployments via file module
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop: "{{ dirs_to_remove }}"
  register: file_rm
  failed_when: false

- name: Force remove stubborn dirs with bash
  become: true
  ansible.builtin.shell: |
    set -euxo pipefail
    echo "Force removing {{ item }}"
    chattr -R -i "{{ item }}" 2>&1 || echo "chattr not supported or failed"
    chmod -R u+rwX "{{ item }}" 2>&1 || echo "chmod failed"
    echo "== lsof =="
    lsof +D "{{ item }}" 2>&1 || echo "No open files or lsof failed"
    echo "== fuser =="
    fuser -vm "{{ item }}" 2>&1 || echo "No processes or fuser failed"
    rm -rf --one-file-system "{{ item }}"
    test ! -e "{{ item }}" && echo "OK removed {{ item }}" || echo "STILL EXISTS: {{ item }}"
  args:
    executable: /bin/bash
  loop: "{{ file_rm.results | selectattr('failed', 'defined') | selectattr('failed') | map(attribute='item') | list }}"
  register: forced_rm
  failed_when: false

- name: Show file module results
  ansible.builtin.debug:
    msg: |
      {{ item.item }} -> changed={{ item.changed|default(false) }} failed={{ item.failed|default(false) }}
      {% if item.msg is defined %}
      msg: {{ item.msg }}
      {% endif %}
  loop: "{{ file_rm.results | default([]) }}"
  loop_control: { label: "{{ item.item }}" }

- name: Show forced rm results
  ansible.builtin.debug:
    msg: |
      {{ item.item }} -> rc={{ item.rc|default('') }}
      stdout:
      {{ (item.stdout or '') | indent(2) }}
      stderr:
      {{ (item.stderr or '') | indent(2) }}
  loop: "{{ forced_rm.results | default([]) }}"
  loop_control: { label: "{{ item.item }}" }

- name: Show final deployment status
  ansible.builtin.shell: |
    echo "=== CLEANUP RESULTS ==="
    echo "Total deployments remaining: $(ls -1 {{ install_root }}/ | grep -E '[0-9]+\.[0-9]+\.[0-9]+' | wc -l)"
    echo "=== Current Symlinks ==="
    ls -la {{ install_root }}/ | grep -E '(current|previous)' || echo "No symlinks found"
    echo "=== Latest Deployments ==="
    ls -lt {{ install_root }}/ | grep -E '[0-9]+\.[0-9]+\.[0-9]+' | head -5
  register: final_status
  changed_when: false

- name: Display cleanup completion summary
  ansible.builtin.debug:
    var: final_status.stdout_lines

- name: Show deletion details
  ansible.builtin.debug:
    var: cleanup_result.results
  when: cleanup_result is defined

- name: Show cleanup completion message
  ansible.builtin.debug:
    msg: "Cleanup completed! Attempted to remove {{ dirs_to_remove | length }} directories."
