# molecule/default/molecule.yml
---
scenario:
  name: default

driver:
  name: docker

platforms:
  - name: instance
    image: "ghcr.io/pulibrary/pul_containers:jammy_multi"
    command: "/lib/systemd/systemd"
    privileged: true
    cgroupns_mode: host
    tmpfs:
      - /run
      - /run/lock
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:rw
    environment:
      container: docker
    pre_build_image: true

provisioner:
  name: ansible
  log: true
  env:
    ANSIBLE_STDOUT_CALLBACK: yaml
    ANSIBLE_CALLBACKS_ENABLED: profile_tasks,profile_roles,timer
    ANSIBLE_FORCE_COLOR: "true"
    ANSIBLE_VERBOSITY: "2"
  config_options:
    defaults:
      roles_path: "$MOLECULE_PROJECT_DIRECTORY/.."
  inventory:
    host_vars:
      instance:
        deploy_user_uid: 1000
        runtime_env: production
  playbooks:
    converge: converge.yml
  options:
    tags: setup,all

verifier:
  name: ansible

lint: |
  set -e
  yamllint .
  ansible-lint
