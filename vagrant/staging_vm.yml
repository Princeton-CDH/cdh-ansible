---
- name: Configure base configurations
  connection: local
  become: true
  hosts: all
  tasks:
    - name: Update all packages on the base box
      yum:
        name: '*'
        state: latest
    - name: Install SCL repo
      yum:
        name: centos-release-scl
        state: present
    - name: Install base packages
      yum:
        name: '{{ item }}'
        state: present
      with_items:
        - rh-python35
        - rh-python36
        - rh-python35-mod_wsgi
        - rh-python36-mod_wsgi
        - rh-nodejs8
        - httpd24-httpd
        - mariadb
        - mariadb-server
        - mariadb-devel
        - MySQL-python
        - lsof
        - java
        - git
    - name: Get service facts
      service_facts:
    - name: Create deploy user
      user:
        user: deploy
        group: apache
        state: present
        createhome: yes
    - name: Create wheel group if not present
      group:
        name: wheel
        state: present
    - name: Grant passwordless sudo to wheel
      lineinfile:
        dest: /etc/sudoers
        state: present
        regexp: '^%wheel'
        line: '%wheel ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'
    - name: Add deploy to wheel
      user:
        name: deploy
        groups: wheel
        append: yes
        state: present
    - name: Give deploy insecure pub_key
      authorized_key:
        user: deploy
        state: present
        key: '{{ lookup("file", "/vagrant/id_rsa.pub")}}'
    - name: Create /srv/www/ if it doesn't exist
      file:
        path: /srv/www
        owner: deploy
        group: apache
        mode: ug+rwx,o+x
        state: directory
    - name: Create /var/www if it doesn't exist
      file:
        path: /var/www
        owner: deploy
        group: apache
        mode: ug+rwx,o+x
        state: directory
    - name: Symlink in httpd24-httpd to /etc/httpd
      file:
        src: /opt/rh/httpd24/root/etc/httpd
        dest: /etc/httpd
        owner: root
        group: root
        state: link
    - name: Configure virtualenv sefcontext rules
      sefcontext:
        target: '/srv/www/prod(/.*)?env(/.*)?'
        setype: httpd_sys_script_exec_t
    - name: Configure log sefcontext rules
      sefcontext:
        target: '/srv/www/prod(/.*)?/*.log'
        setype: httpd_log_t
    - name: Enable services
      service:
        name: '{{ item }}'
        enabled: yes
        state: started
      with_items:
        - mariadb
        - httpd24-httpd
    - name: Configure MySQL user with privs on staging db
      mysql_user:
        name: staging
        password: staging
        priv: 'staging.*:ALL'
        state: present
    - name: Remove staging db if exists
      mysql_db:
        name: staging
        state: absent
    - name: Create staging db
      mysql_db:
        name: staging
        state: present
